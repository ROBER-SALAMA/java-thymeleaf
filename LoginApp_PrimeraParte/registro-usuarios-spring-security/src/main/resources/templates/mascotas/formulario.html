<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <title
      th:text="${mascota.id != null} ? 'Editar Mascota' : 'Nueva Mascota'"
    ></title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div layout:fragment="content" class="w-full h-full">
      <div class="max-w-4xl mx-auto p-6">
        <h1
          class="text-3xl font-bold text-gray-800 mb-6"
          th:text="${mascota.id != null} ? 'Editar Mascota' : 'Nueva Mascota'"
        >
          Nueva Mascota
        </h1>

        <div class="bg-white shadow-xl rounded-lg overflow-hidden">
          <div class="p-8">
            <form
              th:action="${mascota.id != null} ? @{/mascotas/actualizar/{id}(id=${mascota.id})} : @{/mascotas/guardar}"
              method="post"
              th:object="${mascota}"
              enctype="multipart/form-data"
              class="space-y-6"
            >
              <input type="hidden" th:field="*{id}" />

              <!-- Información básica -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nombre -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Nombre *</label
                  >
                  <input
                    type="text"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#978DE3] focus:border-transparent"
                    th:field="*{nombre}"
                    required
                  />
                </div>

                <!-- Especie -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Especie *</label
                  >
                  <input
                    type="text"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#978DE3] focus:border-transparent"
                    th:field="*{especie}"
                    required
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Raza -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Raza *</label
                  >
                  <input
                    type="text"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#978DE3] focus:border-transparent"
                    th:field="*{raza}"
                    required
                  />
                </div>

                <!-- Sexo -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Sexo *</label
                  >
                  <select
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#978DE3] focus:border-transparent"
                    th:field="*{sexo}"
                    required
                  >
                    <option value="">Seleccione sexo</option>
                    <option value="Macho">Macho</option>
                    <option value="Hembra">Hembra</option>
                  </select>
                </div>
              </div>

              <!-- Cliente -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Cliente *</label
                >
                <select
                  th:field="*{clienteId}"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#978DE3] focus:border-transparent"
                  required
                >
                  <option value="">Seleccione un cliente</option>
                  <option
                    th:each="cliente : ${clientes}"
                    th:value="${cliente.id}"
                    th:text="${cliente.nombre + ' ' + cliente.apellido}"
                  ></option>
                </select>
              </div>

              <!-- Imagen -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Foto de la Mascota</label
                >
                <div class="space-y-4">
                  <!-- Vista previa de imagen -->
                  <div
                    th:if="${mascota.imagen != null && !mascota.imagen.isEmpty()}"
                    class="mb-4"
                  >
                    <p class="text-sm text-gray-600 mb-2">Imagen actual:</p>
                    <img
                      th:src="'data:image/jpeg;base64,' + ${mascota.imagen}"
                      class="h-48 w-48 object-cover rounded-lg border border-gray-300"
                      alt="Imagen de mascota"
                    />
                  </div>

                  <!-- Input para subir imagen -->
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
                  >
                    <input
                      type="file"
                      id="imagenInput"
                      name="imagenFile"
                      accept="image/*"
                      class="hidden"
                      onchange="previewImage(event)"
                    />

                    <label
                      for="imagenInput"
                      class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-[#1B8064] hover:bg-[#3DBA95]"
                    >
                      <i class="bi bi-cloud-upload mr-2"></i>
                      <span
                        th:text="${mascota.imagen != null && !mascota.imagen.isEmpty()} ? 'Cambiar Imagen' : 'Subir Imagen'"
                      ></span>
                    </label>

                    <p class="mt-2 text-sm text-gray-500">
                      PNG, JPG o JPEG (Máx. 2MB)
                    </p>
                  </div>

                  <!-- Vista previa de nueva imagen -->
                  <div id="imagePreview" class="hidden">
                    <p class="text-sm text-gray-600 mb-2">Vista previa:</p>
                    <img
                      id="preview"
                      class="h-48 w-48 object-cover rounded-lg border border-gray-300"
                      alt="Vista previa"
                    />
                  </div>

                  <!-- Campo oculto para Base64 -->
                  <input type="hidden" id="imagenBase64" th:field="*{imagen}" />
                </div>
              </div>

              <!-- Botones -->
              <div class="flex justify-between pt-6 border-t border-gray-200">
                <a
                  th:href="@{/mascotas}"
                  class="inline-flex items-center px-5 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                  <i class="bi bi-arrow-left mr-2"></i> Cancelar
                </a>

                <button
                  type="submit"
                  class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-[#1B8064] hover:bg-[#3DBA95]"
                >
                  <i class="bi bi-save mr-2"></i>
                  <span
                    th:text="${mascota.id != null} ? 'Actualizar Mascota' : 'Guardar Mascota'"
                  >
                    Guardar Mascota
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript para manejar imágenes -->
    <script>
      function previewImage(event) {
        const input = event.target;
        const previewContainer = document.getElementById("imagePreview");
        const preview = document.getElementById("preview");
        const base64Input = document.getElementById("imagenBase64");

        if (input.files && input.files[0]) {
          const file = input.files[0];

          // Validar tamaño (2MB máximo)
          if (file.size > 2 * 1024 * 1024) {
            alert("La imagen es demasiado grande. Máximo 2MB.");
            input.value = "";
            return;
          }

          const reader = new FileReader();

          reader.onload = function (e) {
            preview.src = e.target.result;
            previewContainer.classList.remove("hidden");

            // Convertir a Base64 y guardar en campo oculto
            base64Input.value = e.target.result.split(",")[1];
          };

          reader.readAsDataURL(file);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const existingImg = document.querySelector("img[th\\:src]");
        if (existingImg && existingImg.src) {
          const base64Data = existingImg.src.split(",")[1];
          if (base64Data) {
            document.getElementById("imagenBase64").value = base64Data;
          }
        }
      });
    </script>
  </body>
</html>
