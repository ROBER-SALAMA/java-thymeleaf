<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <title>Ventas</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body class="bg-gray-100">
    <div layout:fragment="content" class="w-full h-full">
      <div class="max-w-[84rem] mx-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Ventas</h1>

        <div class="mb-6">
          <a
            th:href="@{/ventas/nueva}"
            class="inline-flex items-center bg-[#1B8064] text-white px-4 py-2 rounded-md hover:bg-[#3DBA95] transition-colors duration-150 text-sm font-medium"
          >
            <i class="bi bi-plus-circle"></i> Nueva Venta
          </a>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-[#978DE3] text-white">
                <tr>
                  <th
                    class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider"
                  >
                    ID
                  </th>
                  <th
                    class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider"
                  >
                    Cliente
                  </th>
                  <th
                    class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider"
                  >
                    Fecha
                  </th>
                  <th
                    class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider"
                  >
                    Método Pago
                  </th>
                  <th
                    class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider"
                  >
                    Total
                  </th>
                  <th
                    class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider"
                  >
                    Estado
                  </th>
                  <th
                    class="px-6 py-4 text-center text-sm font-semibold uppercase tracking-wider"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>

              <tbody class="divide-y divide-gray-200">
                <tr
                  th:each="venta : ${ventas}"
                  class="hover:bg-gray-50 transition-colors duration-150"
                >
                  <!-- ID -->
                  <td
                    class="px-6 py-4 text-sm text-gray-900 font-mono"
                    th:text="${venta.id}"
                  ></td>

                  <!-- Cliente (CÓDIGO CORREGIDO) -->
                  <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">
                      <script th:inline="javascript">
                        /*<![CDATA[*/
                        try {
                          const json = JSON.parse(
                            /*[[${venta.jsonVenta}]]*/ "{}"
                          );
                          const clienteNombre =
                            json.clienteNombre || "Sin nombre";
                          document.write(clienteNombre);
                        } catch (e) {
                          document.write("Error en datos");
                        }
                        /*]]>*/
                      </script>
                    </div>
                  </td>

                  <!-- Fecha -->
                  <td class="px-6 py-4 text-sm text-gray-600">
                    <script th:inline="javascript">
                      /*<![CDATA[*/
                      try {
                        const json = JSON.parse(
                          /*[[${venta.jsonVenta}]]*/ "{}"
                        );
                        document.write(json.fecha || "Sin fecha");
                      } catch (e) {
                        document.write("Sin fecha");
                      }
                      /*]]>*/
                    </script>
                  </td>

                  <!-- Método de Pago -->
                  <td class="px-6 py-4">
                    <script th:inline="javascript">
                      /*<![CDATA[*/
                      try {
                        const json = JSON.parse(
                          /*[[${venta.jsonVenta}]]*/ "{}"
                        );
                        const metodo = json.metodoPago || "N/A";

                        let clase =
                          "px-2 py-1 text-xs font-semibold rounded-full ";
                        if (metodo === "EFECTIVO") {
                          clase += "bg-green-100 text-green-800";
                        } else if (metodo === "TARJETA") {
                          clase += "bg-blue-100 text-blue-800";
                        } else {
                          clase += "bg-purple-100 text-purple-800";
                        }

                        document.write(
                          '<span class="' + clase + '">' + metodo + "</span>"
                        );
                      } catch (e) {
                        document.write(
                          '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">N/A</span>'
                        );
                      }
                      /*]]>*/
                    </script>
                  </td>

                  <!-- Total -->
                  <td class="px-6 py-4 text-sm font-semibold text-gray-900">
                    <script th:inline="javascript">
                      /*<![CDATA[*/
                      try {
                        const json = JSON.parse(
                          /*[[${venta.jsonVenta}]]*/ "{}"
                        );
                        const total = json.total || 0;
                        document.write("$" + total.toFixed(2));
                      } catch (e) {
                        document.write("$0.00");
                      }
                      /*]]>*/
                    </script>
                  </td>

                  <!-- Estado -->
                  <td class="px-6 py-4">
                    <th:block th:if="${venta.activo}">
                      <span
                        class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"
                      >
                        ACTIVA
                      </span>
                    </th:block>
                    <th:block th:unless="${venta.activo}">
                      <span
                        class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"
                      >
                        INACTIVA
                      </span>
                    </th:block>
                  </td>

                  <!-- Acciones -->
                  <td class="px-6 py-4 text-center">
                    <div class="flex justify-center gap-2">
                      <!-- Ver detalles -->
                      <a
                        th:href="@{'/ventas/detalles/' + ${venta.id}}"
                        class="inline-flex items-center bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 transition-colors duration-150 text-sm font-medium"
                        title="Ver detalles"
                      >
                        <i class="bi bi-eye"></i>
                      </a>

                      <!-- Eliminar -->
                      <a
                        th:href="@{'/ventas/eliminar/' + ${venta.id}}"
                        class="inline-flex items-center bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 transition-colors duration-150 text-sm font-medium"
                        onclick="return confirm('¿Estás seguro de eliminar esta venta?')"
                        title="Eliminar"
                      >
                        <i class="bi bi-trash3-fill"></i>
                      </a>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div
          th:if="${#lists.isEmpty(ventas)}"
          class="mt-6 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative"
          role="alert"
        >
          <strong class="font-bold">No hay ventas registradas.</strong>
          <span class="block sm:inline">
            Haz clic en "Nueva Venta" para agregar una.
          </span>
        </div>
      </div>
    </div>
  </body>
</html>
